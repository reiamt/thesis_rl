/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/gym/envs/registration.py:216: UserWarning: [33mWARN: Overriding environment market-maker-v0
  logger.warn("Overriding environment {}".format(id))
[2023-05-22 16:54:09,511, ema.py:68] EMA smoothing ENABLED: 0.99
[2023-05-22 16:54:12,707, data_pipeline.py:49] Imported 101_20200102_merge.csv.xz from a csv in 3 seconds
[2023-05-22 16:54:13,009, ema.py:94] Applying EMA to data...
[2023-05-22 16:54:15,386, data_pipeline.py:49] Imported /XBTUSD_2020-01-03.csv.xz from a csv in 1 seconds
[2023-05-22 16:54:15,579, ema.py:94] Applying EMA to data...
Resetting environment #1 on episode #0.
market-maker-v0 XBTUSD #1 instantiated
observation_space: (100, 159) reward_type = TRADE_COMPLETION max_steps = 86345
Using cpu device
Resetting environment #1 on episode #0.
Logging to ./runs/p6luxgzo/DQN_1
[2023-05-22 16:54:15,807, data_pipeline.py:228] Adding order imbalances...
[2023-05-22 16:54:15,814, ema.py:128] Reset EMA data.
[2023-05-22 16:54:15,814, ema.py:94] Applying EMA to data...
[2023-05-22 16:54:16,002, ema.py:68] EMA smoothing ENABLED: 0.99
[2023-05-22 16:54:16,003, ema.py:68] EMA smoothing ENABLED: 0.99
[2023-05-22 16:54:16,003, ema.py:68] EMA smoothing ENABLED: 0.99
[2023-05-22 16:54:16,003, ema.py:68] EMA smoothing ENABLED: 0.99
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -412.9886
Episode PnL: -1.42%
Trade Count: 1776
Average PnL per Trade: -0.0080%
Total # of episodes: 1
short_inventory_market_orders	=	349
short_inventory_orders_placed	=	579
short_inventory_orders_updated	=	9827
short_inventory_orders_executed	=	578
long_inventory_market_orders	=	310
long_inventory_orders_placed	=	540
long_inventory_orders_updated	=	9798
long_inventory_orders_executed	=	539
First step:	5192
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -7.97e-05 |
|    episode_pnl           | -1.41     |
|    episode_reward        | -412      |
| rollout/                 |           |
|    ep_len_mean           | 1.46e+04  |
|    ep_rew_mean           | -413      |
|    exploration_rate      | 0.722     |
| time/                    |           |
|    episodes              | 1         |
|    fps                   | 2477      |
|    time_elapsed          | 5         |
|    total_timesteps       | 14635     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -422.9875
Episode PnL: -3.48%
Trade Count: 1886
Average PnL per Trade: -0.0185%
Total # of episodes: 2
short_inventory_market_orders	=	412
short_inventory_orders_placed	=	648
short_inventory_orders_updated	=	10755
short_inventory_orders_executed	=	647
long_inventory_market_orders	=	296
long_inventory_orders_placed	=	532
long_inventory_orders_updated	=	10830
long_inventory_orders_executed	=	531
First step:	10955
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000185 |
|    episode_pnl           | -3.48     |
|    episode_reward        | -423      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -418      |
|    exploration_rate      | 0.417     |
| time/                    |           |
|    episodes              | 2         |
|    fps                   | 2409      |
|    time_elapsed          | 12        |
|    total_timesteps       | 30666     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -386.9955
Episode PnL: -3.68%
Trade Count: 1712
Average PnL per Trade: -0.0215%
Total # of episodes: 3
short_inventory_market_orders	=	340
short_inventory_orders_placed	=	574
short_inventory_orders_updated	=	10017
short_inventory_orders_executed	=	573
long_inventory_market_orders	=	283
long_inventory_orders_placed	=	517
long_inventory_orders_updated	=	10003
long_inventory_orders_executed	=	516
First step:	7813
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000215 |
|    episode_pnl           | -3.68     |
|    episode_reward        | -386      |
| rollout/                 |           |
|    ep_len_mean           | 1.52e+04  |
|    ep_rew_mean           | -408      |
|    exploration_rate      | 0.135     |
| time/                    |           |
|    episodes              | 3         |
|    fps                   | 2447      |
|    time_elapsed          | 18        |
|    total_timesteps       | 45544     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -204.9677
Episode PnL: -3.11%
Trade Count: 1432
Average PnL per Trade: -0.0217%
Total # of episodes: 4
short_inventory_market_orders	=	153
short_inventory_orders_placed	=	529
short_inventory_orders_updated	=	6346
short_inventory_orders_executed	=	528
long_inventory_market_orders	=	188
long_inventory_orders_placed	=	564
long_inventory_orders_updated	=	5969
long_inventory_orders_executed	=	563
First step:	144
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000218 |
|    episode_pnl           | -3.11     |
|    episode_reward        | -204      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -357      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 4         |
|    fps                   | 1671      |
|    time_elapsed          | 36        |
|    total_timesteps       | 61051     |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.00648   |
|    n_updates             | 2762      |
----------------------------------------
[2023-05-22 16:54:58,309, broker.py:207] WARNING: Long and Short orders filled in the same step
[2023-05-22 16:54:58,310, broker.py:208] bid=7087.5 | ask=7093.0 | buy_vol=213532.0 | sell_vol=895804.0 | step=20591
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -177.9483
Episode PnL: -4.60%
Trade Count: 1342
Average PnL per Trade: -0.0343%
Total # of episodes: 5
short_inventory_market_orders	=	101
short_inventory_orders_placed	=	553
short_inventory_orders_updated	=	4741
short_inventory_orders_executed	=	552
long_inventory_market_orders	=	119
long_inventory_orders_placed	=	571
long_inventory_orders_updated	=	4646
long_inventory_orders_executed	=	570
First step:	16332
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000341 |
|    episode_pnl           | -4.56     |
|    episode_reward        | -177      |
| rollout/                 |           |
|    ep_len_mean           | 1.56e+04  |
|    ep_rew_mean           | -321      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 5         |
|    fps                   | 1188      |
|    time_elapsed          | 65        |
|    total_timesteps       | 78092     |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.0469    |
|    n_updates             | 7022      |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -138.9632
Episode PnL: -4.09%
Trade Count: 1252
Average PnL per Trade: -0.0326%
Total # of episodes: 6
short_inventory_market_orders	=	113
short_inventory_orders_placed	=	447
short_inventory_orders_updated	=	4090
short_inventory_orders_executed	=	446
long_inventory_market_orders	=	180
long_inventory_orders_placed	=	514
long_inventory_orders_updated	=	4121
long_inventory_orders_executed	=	513
First step:	7751
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000313 |
|    episode_pnl           | -3.9      |
|    episode_reward        | -138      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -291      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 6         |
|    fps                   | 1033      |
|    time_elapsed          | 88        |
|    total_timesteps       | 91895     |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.00366   |
|    n_updates             | 10473     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -175.9612
Episode PnL: -4.45%
Trade Count: 1380
Average PnL per Trade: -0.0322%
Total # of episodes: 7
short_inventory_market_orders	=	140
short_inventory_orders_placed	=	524
short_inventory_orders_updated	=	4423
short_inventory_orders_executed	=	523
long_inventory_market_orders	=	167
long_inventory_orders_placed	=	551
long_inventory_orders_updated	=	4611
long_inventory_orders_executed	=	550
First step:	10989
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000321 |
|    episode_pnl           | -4.42     |
|    episode_reward        | -175      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -274      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 7         |
|    fps                   | 951       |
|    time_elapsed          | 112       |
|    total_timesteps       | 107414    |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.00159   |
|    n_updates             | 14353     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -111.9569
Episode PnL: 0.22%
Trade Count: 1210
Average PnL per Trade: 0.0018%
Total # of episodes: 8
short_inventory_market_orders	=	116
short_inventory_orders_placed	=	474
short_inventory_orders_updated	=	4136
short_inventory_orders_executed	=	473
long_inventory_market_orders	=	132
long_inventory_orders_placed	=	490
long_inventory_orders_updated	=	4108
long_inventory_orders_executed	=	489
First step:	3462
===========================================================================
---------------------------------------
| logger/                  |          |
|    episode_avg_trade_pnl | 1.84e-05 |
|    episode_pnl           | 0.223    |
|    episode_reward        | -112     |
| rollout/                 |          |
|    ep_len_mean           | 1.53e+04 |
|    ep_rew_mean           | -254     |
|    exploration_rate      | 0.05     |
| time/                    |          |
|    episodes              | 8        |
|    fps                   | 902      |
|    time_elapsed          | 135      |
|    total_timesteps       | 122286   |
| train/                   |          |
|    learning_rate         | 0.0001   |
|    loss                  | 0.00235  |
|    n_updates             | 18071    |
---------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -78.9714
Episode PnL: 2.71%
Trade Count: 1226
Average PnL per Trade: 0.0221%
Total # of episodes: 9
short_inventory_market_orders	=	108
short_inventory_orders_placed	=	503
short_inventory_orders_updated	=	4390
short_inventory_orders_executed	=	502
long_inventory_market_orders	=	111
long_inventory_orders_placed	=	506
long_inventory_orders_updated	=	4282
long_inventory_orders_executed	=	505
First step:	12645
===========================================================================
---------------------------------------
| logger/                  |          |
|    episode_avg_trade_pnl | 0.000221 |
|    episode_pnl           | 2.71     |
|    episode_reward        | -79      |
| rollout/                 |          |
|    ep_len_mean           | 1.54e+04 |
|    ep_rew_mean           | -235     |
|    exploration_rate      | 0.05     |
| time/                    |          |
|    episodes              | 9        |
|    fps                   | 865      |
|    time_elapsed          | 160      |
|    total_timesteps       | 138663   |
| train/                   |          |
|    learning_rate         | 0.0001   |
|    loss                  | 0.0377   |
|    n_updates             | 22165    |
---------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -109.9494
Episode PnL: -1.25%
Trade Count: 1178
Average PnL per Trade: -0.0107%
Total # of episodes: 10
short_inventory_market_orders	=	115
short_inventory_orders_placed	=	455
short_inventory_orders_updated	=	3970
short_inventory_orders_executed	=	454
long_inventory_market_orders	=	135
long_inventory_orders_placed	=	475
long_inventory_orders_updated	=	4015
long_inventory_orders_executed	=	474
First step:	2962
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000107 |
|    episode_pnl           | -1.25     |
|    episode_reward        | -109      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -222      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 10        |
|    fps                   | 833       |
|    time_elapsed          | 183       |
|    total_timesteps       | 153203    |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.000877  |
|    n_updates             | 25800     |
----------------------------------------
Traceback (most recent call last):
  File "main_experiments.py", line 24, in <module>
    agent.start()
  File "/Users/tam/Documents/thesis/thesis_rl/agent/sb3_gpt.py", line 41, in start
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/stable_baselines3/dqn/dqn.py", line 269, in learn
    return super().learn(
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/stable_baselines3/common/off_policy_algorithm.py", line 330, in learn
    self.train(batch_size=self.batch_size, gradient_steps=gradient_steps)
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/stable_baselines3/dqn/dqn.py", line 219, in train
    loss.backward()
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/torch/_tensor.py", line 487, in backward
    torch.autograd.backward(
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/torch/autograd/__init__.py", line 200, in backward
    Variable._execution_engine.run_backward(  # Calls into the C++ engine to run the backward pass
KeyboardInterrupt