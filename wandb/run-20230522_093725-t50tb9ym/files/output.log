[2023-05-22 09:37:28,309, ema.py:67] EMA smoothing ENABLED: 0.99
[2023-05-22 09:37:31,625, data_pipeline.py:49] Imported 101_20200102_merge.csv.xz from a csv in 3 seconds
[2023-05-22 09:37:31,844, ema.py:93] Applying EMA to data...
[2023-05-22 09:37:34,066, data_pipeline.py:49] Imported /XBTUSD_2020-01-03.csv.xz from a csv in 1 seconds
[2023-05-22 09:37:34,250, ema.py:93] Applying EMA to data...
[2023-05-22 09:37:34,472, data_pipeline.py:228] Adding order imbalances...
Resetting environment #1 on episode #0.
market-maker-v0 XBTUSD #1 instantiated
observation_space: (100, 174) reward_type = TRADE_COMPLETION max_steps = 86345
Using cpu device
Resetting environment #1 on episode #0.
Logging to ./runs/t50tb9ym/DQN_1
[2023-05-22 09:37:34,491, ema.py:127] Reset EMA data.
[2023-05-22 09:37:34,491, ema.py:93] Applying EMA to data...
[2023-05-22 09:37:34,684, ema.py:67] EMA smoothing ENABLED: 0.99
[2023-05-22 09:37:34,684, ema.py:67] EMA smoothing ENABLED: 0.99
[2023-05-22 09:37:34,684, ema.py:67] EMA smoothing ENABLED: 0.99
[2023-05-22 09:37:34,684, ema.py:67] EMA smoothing ENABLED: 0.99
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -396.9846
Episode PnL: -2.33%
Trade Count: 1648
Average PnL per Trade: -0.0141%
Total # of episodes: 1
short_inventory_market_orders	=	357
short_inventory_orders_placed	=	572
short_inventory_orders_updated	=	9847
short_inventory_orders_executed	=	571
long_inventory_market_orders	=	253
long_inventory_orders_placed	=	468
long_inventory_orders_updated	=	9959
long_inventory_orders_executed	=	467
First step:	5192
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000141 |
|    episode_pnl           | -2.32     |
|    episode_reward        | -396      |
| rollout/                 |           |
|    ep_len_mean           | 1.46e+04  |
|    ep_rew_mean           | -397      |
|    exploration_rate      | 0.722     |
| time/                    |           |
|    episodes              | 1         |
|    fps                   | 2673      |
|    time_elapsed          | 5         |
|    total_timesteps       | 14635     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -390.9846
Episode PnL: -2.63%
Trade Count: 1712
Average PnL per Trade: -0.0153%
Total # of episodes: 2
short_inventory_market_orders	=	355
short_inventory_orders_placed	=	595
short_inventory_orders_updated	=	10760
short_inventory_orders_executed	=	594
long_inventory_market_orders	=	262
long_inventory_orders_placed	=	502
long_inventory_orders_updated	=	10855
long_inventory_orders_executed	=	501
First step:	10955
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000153 |
|    episode_pnl           | -2.62     |
|    episode_reward        | -390      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -394      |
|    exploration_rate      | 0.417     |
| time/                    |           |
|    episodes              | 2         |
|    fps                   | 2757      |
|    time_elapsed          | 11        |
|    total_timesteps       | 30666     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -408.9932
Episode PnL: -2.42%
Trade Count: 1794
Average PnL per Trade: -0.0135%
Total # of episodes: 3
short_inventory_market_orders	=	374
short_inventory_orders_placed	=	625
short_inventory_orders_updated	=	9966
short_inventory_orders_executed	=	624
long_inventory_market_orders	=	273
long_inventory_orders_placed	=	524
long_inventory_orders_updated	=	10144
long_inventory_orders_executed	=	523
First step:	7813
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000135 |
|    episode_pnl           | -2.42     |
|    episode_reward        | -408      |
| rollout/                 |           |
|    ep_len_mean           | 1.52e+04  |
|    ep_rew_mean           | -399      |
|    exploration_rate      | 0.135     |
| time/                    |           |
|    episodes              | 3         |
|    fps                   | 2786      |
|    time_elapsed          | 16        |
|    total_timesteps       | 45544     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -225.9511
Episode PnL: -2.82%
Trade Count: 1418
Average PnL per Trade: -0.0199%
Total # of episodes: 4
short_inventory_market_orders	=	166
short_inventory_orders_placed	=	488
short_inventory_orders_updated	=	6447
short_inventory_orders_executed	=	487
long_inventory_market_orders	=	222
long_inventory_orders_placed	=	543
long_inventory_orders_updated	=	6267
long_inventory_orders_executed	=	543
First step:	144
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000213 |
|    episode_pnl           | -3.01     |
|    episode_reward        | -227      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -356      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 4         |
|    fps                   | 1753      |
|    time_elapsed          | 34        |
|    total_timesteps       | 61051     |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.0203    |
|    n_updates             | 2762      |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -169.9778
Episode PnL: -3.77%
Trade Count: 1274
Average PnL per Trade: -0.0296%
Total # of episodes: 5
short_inventory_market_orders	=	190
short_inventory_orders_placed	=	514
short_inventory_orders_updated	=	4776
short_inventory_orders_executed	=	513
long_inventory_market_orders	=	124
long_inventory_orders_placed	=	448
long_inventory_orders_updated	=	4888
long_inventory_orders_executed	=	447
First step:	16332
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000302 |
|    episode_pnl           | -3.84     |
|    episode_reward        | -171      |
| rollout/                 |           |
|    ep_len_mean           | 1.56e+04  |
|    ep_rew_mean           | -319      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 5         |
|    fps                   | 1285      |
|    time_elapsed          | 60        |
|    total_timesteps       | 78092     |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.00237   |
|    n_updates             | 7022      |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -112.9577
Episode PnL: -1.01%
Trade Count: 1098
Average PnL per Trade: -0.0092%
Total # of episodes: 6
short_inventory_market_orders	=	120
short_inventory_orders_placed	=	465
short_inventory_orders_updated	=	3892
short_inventory_orders_executed	=	464
long_inventory_market_orders	=	85
long_inventory_orders_placed	=	430
long_inventory_orders_updated	=	4103
long_inventory_orders_executed	=	429
First step:	7751
===========================================================================
---------------------------------------
| logger/                  |          |
|    episode_avg_trade_pnl | -9.8e-05 |
|    episode_pnl           | -1.07    |
|    episode_reward        | -113     |
| rollout/                 |          |
|    ep_len_mean           | 1.53e+04 |
|    ep_rew_mean           | -284     |
|    exploration_rate      | 0.05     |
| time/                    |          |
|    episodes              | 6        |
|    fps                   | 1085     |
|    time_elapsed          | 84       |
|    total_timesteps       | 91895    |
| train/                   |          |
|    learning_rate         | 0.0001   |
|    loss                  | 0.0167   |
|    n_updates             | 10473    |
---------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -139.9526
Episode PnL: -2.29%
Trade Count: 1318
Average PnL per Trade: -0.0174%
Total # of episodes: 7
short_inventory_market_orders	=	132
short_inventory_orders_placed	=	514
short_inventory_orders_updated	=	4105
short_inventory_orders_executed	=	513
long_inventory_market_orders	=	146
long_inventory_orders_placed	=	528
long_inventory_orders_updated	=	4205
long_inventory_orders_executed	=	527
First step:	10989
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000176 |
|    episode_pnl           | -2.3      |
|    episode_reward        | -139      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -264      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 7         |
|    fps                   | 977       |
|    time_elapsed          | 109       |
|    total_timesteps       | 107414    |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.00686   |
|    n_updates             | 14353     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -123.9524
Episode PnL: -2.52%
Trade Count: 1132
Average PnL per Trade: -0.0223%
Total # of episodes: 8
short_inventory_market_orders	=	84
short_inventory_orders_placed	=	443
short_inventory_orders_updated	=	4303
short_inventory_orders_executed	=	442
long_inventory_market_orders	=	124
long_inventory_orders_placed	=	483
long_inventory_orders_updated	=	4152
long_inventory_orders_executed	=	482
First step:	3462
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000222 |
|    episode_pnl           | -2.51     |
|    episode_reward        | -123      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -246      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 8         |
|    fps                   | 921       |
|    time_elapsed          | 132       |
|    total_timesteps       | 122286    |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.00232   |
|    n_updates             | 18071     |
----------------------------------------
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -179.9625
Episode PnL: -4.05%
Trade Count: 1314
Average PnL per Trade: -0.0308%
Total # of episodes: 9
short_inventory_market_orders	=	122
short_inventory_orders_placed	=	480
short_inventory_orders_updated	=	4221
short_inventory_orders_executed	=	479
long_inventory_market_orders	=	178
long_inventory_orders_placed	=	536
long_inventory_orders_updated	=	4150
long_inventory_orders_executed	=	535
First step:	12645
===========================================================================
---------------------------------------
| logger/                  |          |
|    episode_avg_trade_pnl | -0.00032 |
|    episode_pnl           | -4.2     |
|    episode_reward        | -181     |
| rollout/                 |          |
|    ep_len_mean           | 1.54e+04 |
|    ep_rew_mean           | -239     |
|    exploration_rate      | 0.05     |
| time/                    |          |
|    episodes              | 9        |
|    fps                   | 873      |
|    time_elapsed          | 158      |
|    total_timesteps       | 138663   |
| train/                   |          |
|    learning_rate         | 0.0001   |
|    loss                  | 0.00282  |
|    n_updates             | 22165    |
---------------------------------------
[2023-05-22 09:40:15,669, broker.py:207] WARNING: Long and Short orders filled in the same step
[2023-05-22 09:40:15,670, broker.py:208] bid=7092.5 | ask=7100.0 | buy_vol=1190267.0 | sell_vol=1250607.0 | step=20587
------------------------- XBTUSD-1 TRADE_COMPLETION EPISODE RESET -------------------------
Episode Reward: -127.9447
Episode PnL: -2.18%
Trade Count: 1182
Average PnL per Trade: -0.0184%
Total # of episodes: 10
short_inventory_market_orders	=	116
short_inventory_orders_placed	=	484
short_inventory_orders_updated	=	3743
short_inventory_orders_executed	=	484
long_inventory_market_orders	=	107
long_inventory_orders_placed	=	476
long_inventory_orders_updated	=	3991
long_inventory_orders_executed	=	475
First step:	2962
===========================================================================
----------------------------------------
| logger/                  |           |
|    episode_avg_trade_pnl | -0.000167 |
|    episode_pnl           | -1.96     |
|    episode_reward        | -127      |
| rollout/                 |           |
|    ep_len_mean           | 1.53e+04  |
|    ep_rew_mean           | -228      |
|    exploration_rate      | 0.05      |
| time/                    |           |
|    episodes              | 10        |
|    fps                   | 846       |
|    time_elapsed          | 180       |
|    total_timesteps       | 153203    |
| train/                   |           |
|    learning_rate         | 0.0001    |
|    loss                  | 0.0148    |
|    n_updates             | 25800     |
----------------------------------------
Traceback (most recent call last):
  File "agent/sb3.py", line 103, in <module>
    total_timesteps=config['total_timesteps'],
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/stable_baselines3/dqn/dqn.py", line 269, in learn
    return super().learn(
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/stable_baselines3/common/off_policy_algorithm.py", line 330, in learn
    self.train(batch_size=self.batch_size, gradient_steps=gradient_steps)
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/stable_baselines3/dqn/dqn.py", line 195, in train
    replay_data = self.replay_buffer.sample(batch_size, env=self._vec_normalize_env)  # type: ignore[union-attr]
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/stable_baselines3/common/buffers.py", line 285, in sample
    return super().sample(batch_size=batch_size, env=env)
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/stable_baselines3/common/buffers.py", line 111, in sample
    return self._get_samples(batch_inds, env=env)
  File "/Users/tam/miniconda3/envs/thesis/lib/python3.8/site-packages/stable_baselines3/common/buffers.py", line 301, in _get_samples
    next_obs = self._normalize_obs(self.next_observations[batch_inds, env_indices, :], env)
KeyboardInterrupt